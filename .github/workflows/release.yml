name: Release Published

on:
  release:
    types: [published]

permissions:
  contents: write
  pull-requests: read

jobs:
  on-release-published:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v5
        with:
          fetch-depth: 0  # Fetch all history for tags

      - name: Get release info
        id: release_info
        run: |
          RELEASE_TAG="${{ github.event.release.tag_name }}"
          RELEASE_NAME="${{ github.event.release.name }}"

          # Save release body to output (multiline)
          echo "release_tag=${RELEASE_TAG}" >> $GITHUB_OUTPUT
          echo "release_name=${RELEASE_NAME}" >> $GITHUB_OUTPUT
          echo "release_body<<EOF" >> $GITHUB_OUTPUT
          echo "${{ github.event.release.body }}" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

          echo "=================================="
          echo "Release Information"
          echo "=================================="
          echo "Tag: ${RELEASE_TAG}"
          echo "Title: ${RELEASE_NAME}"
          echo ""
          echo "Description:"
          echo "${{ github.event.release.body }}"
          echo "=================================="

      - name: Release build starting
        run: |
          echo "=================================="
          echo "Release Build Starting"
          echo "=================================="
          echo "Release: ${{ steps.release_info.outputs.release_tag }}"
          echo "Status: Building..."
          echo "=================================="

      - name: Create bundle (simulate with sleep)
        id: bundle
        run: |
          echo "Creating bundle..."
          sleep 10
          echo "Bundle created successfully!"

      - name: Create and push tag
        run: bash .github/scripts/create-and-push-tag.sh "${{ steps.release_info.outputs.release_tag }}"

      - name: Release build successful
        if: success()
        run: |
          echo "=================================="
          echo "✓ Release Build Successful"
          echo "=================================="
          echo "Release: ${{ steps.release_info.outputs.release_tag }}"
          echo "Status: Build Successful"
          echo ""
          echo "Release URL: ${{ github.event.release.html_url }}"
          echo "=================================="

      - name: Release build failed
        if: failure()
        run: |
          echo "=================================="
          echo "✗ Release Build Failed"
          echo "=================================="
          echo "Release: ${{ steps.release_info.outputs.release_tag }}"
          echo "Status: Build Failed"
          echo ""
          echo "Workflow Run: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          echo "=================================="
