name: Update Release Draft

on:
  pull_request:
    types: [closed]
    branches:
      - main

permissions:
  contents: write
  pull-requests: read

jobs:
  update-draft:
    # Only run if the PR was actually merged (not just closed)
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v5
        with:
          fetch-depth: 0  # Fetch all history for tags

      - name: Get latest tag and next version
        id: version
        run: |
          # Get the latest tag matching web-api/*
          LATEST_TAG=$(git tag -l "web-api/*" | sort -V | tail -n 1)

          if [ -z "$LATEST_TAG" ]; then
            # No existing tags, start with 0.0.1
            NEXT_VERSION="0.0.1"
            LATEST_TAG=""
          else
            # Extract version number and increment patch
            VERSION=${LATEST_TAG#web-api/}
            IFS='.' read -r -a VERSION_PARTS <<< "$VERSION"
            MAJOR="${VERSION_PARTS[0]}"
            MINOR="${VERSION_PARTS[1]}"
            PATCH="${VERSION_PARTS[2]}"

            # Increment patch version
            PATCH=$((PATCH + 1))
            NEXT_VERSION="${MAJOR}.${MINOR}.${PATCH}"
          fi

          NEXT_TAG="web-api/${NEXT_VERSION}"

          echo "latest_tag=${LATEST_TAG}" >> $GITHUB_OUTPUT
          echo "next_version=${NEXT_VERSION}" >> $GITHUB_OUTPUT
          echo "next_tag=${NEXT_TAG}" >> $GITHUB_OUTPUT

          echo "Latest tag: ${LATEST_TAG}"
          echo "Next version: ${NEXT_VERSION}"
          echo "Next tag: ${NEXT_TAG}"

      - name: Get merged PRs since last release
        id: get_prs
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          LATEST_TAG="${{ steps.version.outputs.latest_tag }}"

          if [ -z "$LATEST_TAG" ]; then
            # Get all merged PRs if no previous release
            echo "No previous tag found, getting all merged PRs..."
            COMMIT_RANGE="main"
          else
            # Get commits since the last tag
            echo "Getting PRs since tag: ${LATEST_TAG}"
            COMMIT_RANGE="${LATEST_TAG}..main"
          fi

          # Get all commit SHAs in the range
          COMMITS=$(git log $COMMIT_RANGE --format="%H" --merges)

          if [ -z "$COMMITS" ]; then
            echo "No merge commits found"
            PR_SUMMARY="No PRs found since last release"
          else
            # Extract PR numbers from merge commits and get PR details
            PR_NUMBERS=$(echo "$COMMITS" | while read sha; do
              git log -1 --format="%s" $sha | grep -oP '(?<=Merge pull request #)\d+' || true
            done | sort -u)

            if [ -z "$PR_NUMBERS" ]; then
              echo "No PR numbers found in merge commits"
              PR_SUMMARY="No PRs found since last release"
            else
              # Get PR details for each number
              PR_DETAILS=""
              for pr_num in $PR_NUMBERS; do
                PR_INFO=$(gh pr view $pr_num --json number,title --jq '"\(.number)|\(.title)"')
                PR_DETAILS="${PR_DETAILS}${PR_INFO}"$'\n'
              done

              # Build PR summary
              PR_SUMMARY=$(echo "$PR_DETAILS" | grep -v '^$' | awk -F'|' '{print "• #" $1 ": " $2}')
            fi
          fi

          # Save to output (use delimiter for multiline)
          echo "pr_summary<<EOF" >> $GITHUB_OUTPUT
          echo "$PR_SUMMARY" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

          echo "PRs included:"
          echo "$PR_SUMMARY"

      - name: Create or update release draft
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          NEXT_TAG="${{ steps.version.outputs.next_tag }}"
          NEXT_VERSION="${{ steps.version.outputs.next_version }}"
          LATEST_TAG="${{ steps.version.outputs.latest_tag }}"

          # Create release notes
          if [ -z "$LATEST_TAG" ]; then
            CHANGELOG_LINK="https://github.com/${{ github.repository }}/commits/main"
          else
            CHANGELOG_LINK="https://github.com/${{ github.repository }}/compare/${LATEST_TAG}...main"
          fi

          RELEASE_NOTES=$(cat <<EOF
          ## What's Changed

          ${{ steps.get_prs.outputs.pr_summary }}

          **Full Changelog**: ${CHANGELOG_LINK}
          EOF
          )

          # Check if draft release already exists (check if tag exists in releases)
          EXISTING_DRAFT=$(gh release view ${NEXT_TAG} --json isDraft --jq '.isDraft' 2>/dev/null || echo "false")

          if [ "$EXISTING_DRAFT" = "true" ]; then
            echo "Updating existing draft release for ${NEXT_TAG}..."
            gh release edit ${NEXT_TAG} \
              --draft \
              --title "Release ${NEXT_VERSION}" \
              --notes "$RELEASE_NOTES"
            echo "Draft release updated"
          else
            echo "Creating new draft release for ${NEXT_TAG}..."
            # Delete the tag if it exists (in case there's a non-draft release)
            gh release delete ${NEXT_TAG} --yes 2>/dev/null || true
            git tag -d ${NEXT_TAG} 2>/dev/null || true
            git push origin :refs/tags/${NEXT_TAG} 2>/dev/null || true

            gh release create ${NEXT_TAG} \
              --draft \
              --title "Release ${NEXT_VERSION}" \
              --notes "$RELEASE_NOTES" \
              --target main
            echo "Draft release created"
          fi

          RELEASE_URL="https://github.com/${{ github.repository }}/releases/tag/${NEXT_TAG}"

          echo "=================================="
          echo "✓ Release Draft Updated"
          echo "=================================="
          echo "Next Version: ${NEXT_TAG}"
          echo "Release URL: ${RELEASE_URL}"
          echo "=================================="
